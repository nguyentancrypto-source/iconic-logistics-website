name: Backlog IssueOps

on:
  push:
    paths:
      - 'BACKLOG.md'
  workflow_dispatch:

jobs:
  backlog-to-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Parse BACKLOG.md and create issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const backlog = fs.readFileSync('BACKLOG.md', 'utf8');
            const lines = backlog.split('\n');
            const issueTasks = [];
            const regex = /^- \[ \] (.+)$/;
            for (const line of lines) {
              const match = line.match(regex);
              if (match) {
                issueTasks.push(match[1].trim());
              }
            }
            // Get all open issues with label 'backlog'
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'backlog',
              per_page: 100
            });
            for (const task of issueTasks) {
              // Check if issue with same title exists
              const exists = issues.some(issue => issue.title === task);
              if (!exists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: task,
                  body: 'Tự động tạo từ BACKLOG.md.\n\nCập nhật trạng thái bằng cách check vào BACKLOG.md.',
                  labels: ['backlog', 'auto']
                });
              }
            }
